<div class="container-fluid mt-3">

  <!-- ุดุงุดุฉ ุนุฑุถ ุงูุนููุฏ -->
  <div *ngIf="!showForm">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">๐ ุฅุฏุงุฑุฉ ุนููุฏ ุงูููุธููู</h4>
        <div class="d-flex align-items-center gap-2">
          <input type="text" class="form-control" placeholder="ุงุจุญุซ ุนู ููุธู ุฃู ุจูุฏ..."
            [(ngModel)]="contractSearchKeyword" (input)="filterContracts()" />

          <button class="btn btn-success" (click)="openAddForm()">
            <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ
          </button>
        </div>
      </div>

      <div class="card-body">
        <div *ngIf="groupedContracts.length > 0; else noData">
          <div *ngFor="let group of groupedContracts" class="accordion-item mb-2 border rounded shadow-sm">

            <div class="accordion-header p-2 d-flex justify-content-between align-items-center"
              (click)="toggleEmployee(group.staff_name)">
              <h5 class="mb-0">{{ group.staff_name }}</h5>
              <i class="fa" [ngClass]="openedEmployee === group.staff_name ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>

            <div class="accordion-body px-3 py-2" *ngIf="openedEmployee === group.staff_name">
              <ul class="list-group">
                <li *ngFor="let clause of group.clauses"
                  class="list-group-item d-flex justify-content-between align-items-start">

                  <div>
                    <div class="fw-bold text-primary">{{ clause.ClauseName }}</div>
                    <small class="text-muted">{{ clause.ClauseDescription }}</small>
                  </div>

                  <button class="btn btn-sm btn-danger align-self-center"
                    (click)="deleteContractByClause(group.staff_name, clause.ClauseId)">
                    ุญุฐู
                  </button>

                </li>
              </ul>
            </div>
          </div>
        </div>

        <ng-template #noData>
          <p class="text-center text-muted mt-3">ูุง ุชูุฌุฏ ุนููุฏ ุญุงููุงู.</p>
        </ng-template>
      </div>
    </div>
  </div>


  <!-- ุดุงุดุฉ ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ -->
  <div *ngIf="showForm">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">โ ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ</h4>
        <button class="btn btn-secondary" (click)="showForm = false">
          <i class="fa-solid fa-arrow-left"></i> ุฑุฌูุน
        </button>
      </div>

      <div class="card-body">

        <!-- ุงูุจุญุซ ุนู ููุธู -->
        <div class="mb-3">
          <label>๐ ุงุจุญุซ ุนู ููุธู</label>
          <input type="text" class="form-control" [(ngModel)]="searchKeyword" (input)="searchStaff()"
            placeholder="ุงูุชุจ ุงุณู ุงูููุธู..." />
          <ul *ngIf="staffList.length" class="list-group mt-1">
            <li *ngFor="let s of staffList" class="list-group-item list-group-item-action" (click)="selectStaff(s)">
              {{ s.staff_name }}
            </li>
          </ul>
        </div>

        <div *ngIf="selectedStaff" class="alert alert-info">ุชู ุงุฎุชูุงุฑ: <strong>{{ selectedStaff.staff_name }}</strong>
        </div>

        <div class="mb-3 mt-3">
          <label for="staffType">๐งพ ุงุฎุชุฑ ููุน ุงูุนูุฏ</label>
          <select id="staffType" class="form-control" [(ngModel)]="selectedStaffType">
            <option value="">-- ุงุฎุชุฑ ููุน ุงูุนูุฏ --</option>
<option *ngFor="let t of staffTypes" [value]="t.staff_type_sys_key">{{ t.a_desc }}</option>
          </select>
        </div>

        <hr>


        <!-- โ ุฅุถุงูุฉ ุจูุฏ ุฌุฏูุฏ -->
        <div class="card mb-4 border-success">
          <div class="card-body">
            <h5 class="text-success mb-3">โ ุฅุถุงูุฉ ุจูุฏ ุฌุฏูุฏ</h5>

            <input type="text" class="form-control mb-2" placeholder="ุงุณู ุงูุจูุฏ" [(ngModel)]="newClause.ClauseName" />
            <textarea class="form-control mb-2" placeholder="ุงููุตู" rows="2"
              [(ngModel)]="newClause.ClauseDescription"></textarea>

            <button class="btn btn-success" (click)="addClause()">
              <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ ุงูุจูุฏ
            </button>
          </div>
        </div>


        <!-- โ ุงุฎุชูุงุฑ ุงูุจููุฏ ููููุธู -->
        <h5>ุงุฎุชุฑ ุงูุจููุฏ ููููุธู</h5>
        <input type="text" class="form-control mb-2" placeholder="ุงุจุญุซ ุนู ุจูุฏ..." [(ngModel)]="clauseSearchKeyword"
          (input)="searchClauses()" />

        <ul *ngIf="filteredClauses.length" class="list-group mb-3 clause-list-scroll">

          <li *ngFor="let c of filteredClauses"
            class="list-group-item d-flex justify-content-between align-items-center">

            <div>
              <div class="fw-bold">{{ c.ClauseName }}</div>
              <small class="text-muted">{{ c.ClauseDescription }}</small>
            </div>

            <div class="d-flex gap-1">

              <!-- โ ุฒุฑ ุฅุถุงูุฉ ุงูุจูุฏ ููููุธู -->
              <button class="btn btn-sm btn-outline-success" [disabled]="selectedClauses.includes(c.ClauseId)"
                (click)="toggleClause(c.ClauseId)">
                โ
              </button>

              <!-- โ ุฒุฑ ุชุนุฏูู ุงูุจูุฏ -->
              <button class="btn btn-sm btn-outline-primary" (click)="editClause(c)">
                โ๏ธ
              </button>

            </div>
          </li>

        </ul>


        <!-- โ ุนุฑุถ ุงูุจููุฏ ุงููุฎุชุงุฑุฉ -->
        <div class="alert alert-info" *ngIf="selectedClauses.length">
          <strong>ุงูุจููุฏ ุงููุฎุชุงุฑุฉ:</strong>
          <ul>
            <li *ngFor="let id of selectedClauses">
              {{ getClauseName(id) }}
            </li>
          </ul>
        </div>


        <!-- โ ุฒุฑ ุญูุธ ุงูุนูุฏ -->
        <button class="btn btn-primary" [disabled]="!selectedStaff || !selectedClauses.length"
          (click)="saveContract()">
          ๐พ ุญูุธ ุงูุนูุฏ
        </button>

      </div>
    </div>
  </div>


  <!-- โ Popup ุชุนุฏูู ุจูุฏ ููุง ๐ -->
  <div *ngIf="editingClause" class="edit-overlay" (click)="cancelEdit()">

    <div class="edit-popup" (click)="$event.stopPropagation()">
      <h5 class="mb-2">โ๏ธ ุชุนุฏูู ุงูุจูุฏ</h5>

      <input class="form-control mb-2" [(ngModel)]="editingClause.ClauseName" placeholder="ุงุณู ุงูุจูุฏ">

      <textarea class="form-control mb-2" rows="3" [(ngModel)]="editingClause.ClauseDescription"
        placeholder="ูุตู ุงูุจูุฏ"></textarea>

      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-success btn-sm" (click)="updateClause()">ุญูุธ โ</button>
        <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">ุฅูุบุงุก โ</button>
      </div>
    </div>

  </div>

</div>
